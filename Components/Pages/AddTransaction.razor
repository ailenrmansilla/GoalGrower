@page "/addtransaction/{GoalId:int}"
@layout MainLayout

@using GoalGrower.Data
@using GoalGrower.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations

@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<UserModel> UserManager
@inject AppDbContext Db
@inject NavigationManager Nav

<PageTitle>Goal Grower - Add New Transaction</PageTitle>

<div class="add-transaction-container">
    <h1>Add Transaction</h1>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">@errorMessage</div>
    }

    @* Add Transaction Form *@
    @* Uses bind to connect the inputs to the TransactionModel *@
    <EditForm FormName="AddTransactionForm" Model="transactionModel" OnValidSubmit="HandleAddTransaction">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <label for="TransactionDate">Date:</label>
        <InputDate id="TransactionDate" class="form-input" @bind-Value="transactionModel.TransactionDate" />
        <ValidationMessage For="() => transactionModel.TransactionDate" />

        <label for="TransactionDescription">Description (optional):</label>
        <InputText id="TransactionDescription" class="form-input" @bind-Value="transactionModel.TransactionDescription"
            placeholder="Enter description" />
        <ValidationMessage For="() => transactionModel.TransactionDescription" />

        <label>Type:</label>
        <InputRadioGroup @bind-Value="transactionModel.TransactionType">
            <label class="radio-inline">
                <InputRadio Value="TransactionModel.TransactionTypeEnum.Deposit" /> Deposit
            </label>
            <label class="radio-inline">
                <InputRadio Value="TransactionModel.TransactionTypeEnum.Withdrawal" /> Withdrawal
            </label>
        </InputRadioGroup>
        <ValidationMessage For="() => transactionModel.TransactionType" />

        <label for="TransactionAmount">Amount:</label>
        <InputNumber id="TransactionAmount" class="form-input" @bind-Value="transactionModel.TransactionAmount"
            TValue="decimal" />
        <ValidationMessage For="() => transactionModel.TransactionAmount" />

        <div class="form-button-options">
            <button type="submit" class="btn-primary">Add Transaction</button>
            <a class="btn-secondary" href="/goaldetails/@GoalId">Cancel</a>
        </div>
    </EditForm>
</div>

@code {
    // Get GoalId from route parameter
    [Parameter]
    public int GoalId { get; set; }

    // Get AuthenticationState via CascadingParameter
    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    // TransactionModel instance to bind to the form
    private TransactionModel transactionModel { get; set; } = new TransactionModel()
    {
        TransactionDate = DateTime.Today
    };

    // For displaying error messages
    private string errorMessage = string.Empty;

    // OnInitializedAsync to set UserId in transactionModel
    protected override async Task OnInitializedAsync()
    {
        // Initialize UserId early so validation passes
        var authState = await AuthStateTask;
        var user = await UserManager.GetUserAsync(authState.User);

        if (user == null)
        {
            errorMessage = "Access denied. You must be signed in.";
            return;
        }

        transactionModel.UserId = user.Id;
        transactionModel.TransactionDate = DateTime.Today; // default to today
    }

    // Handle form submission
    // Adds the transaction to the database and navigates back to goal details
    private async Task HandleAddTransaction()
    {
        errorMessage = string.Empty;

        try
        {
            // Ensure goal exists
            var goal = await Db.Goals.FirstOrDefaultAsync(g => g.GoalId == GoalId);
            if (goal == null)
            {
                errorMessage = "Goal not found.";
                return;
            }

            // Assign GoalId (already have UserId)
            transactionModel.GoalId = GoalId;

            Db.Transactions.Add(transactionModel);
            await Db.SaveChangesAsync();

            Nav.NavigateTo($"/goaldetails/{GoalId}");
        }
        catch (DbUpdateException dbEx)
        {
            errorMessage = $"Database error: {dbEx.Message}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving transaction: {ex.Message}";
        }
    }
}