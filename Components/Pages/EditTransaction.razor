@page "/edittransaction/{TransactionId:int}"
@layout MainLayout

@using GoalGrower.Data
@using GoalGrower.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore

@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<UserModel> UserManager
@inject AppDbContext Db
@inject NavigationManager Nav

<PageTitle>Goal Grower - Edit Transaction</PageTitle>

<h1>Edit Transaction</h1>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p>
}
else if (transaction == null)
{
    <p>Loading transaction...</p>
}
else
{
    @* Content loaded from database and uses TransactionModel *@
    <EditForm FormName="EditTransactionForm" Model="transaction" OnValidSubmit="HandleEditTransaction">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <label>Date:</label>
        <InputDate class="form-input" @bind-Value="transaction.TransactionDate" />

        <label>Description:</label>
        <InputText class="form-input" @bind-Value="transaction.TransactionDescription" />

        <label>Type:</label>
        <InputRadioGroup @bind-Value="transaction.TransactionType">
            <label class="radio-inline">
                <InputRadio Value="TransactionModel.TransactionTypeEnum.Deposit" /> Deposit
            </label>
            <label class="radio-inline">
                <InputRadio Value="TransactionModel.TransactionTypeEnum.Withdrawal" /> Withdrawal
            </label>
        </InputRadioGroup>

        <label>Amount:</label>
        <InputNumber class="form-input" @bind-Value="transaction.TransactionAmount" TValue="decimal" />

        <div class="form-button-options">
            <button type="submit" class="btn-primary">Save Changes</button>
            <a class="btn-secondary" href="/goaldetails/@transaction.GoalId">Cancel</a>
        </div>
    </EditForm>
}

@code {
    // Parameter for TransactionId from route
    [Parameter]
    public int TransactionId { get; set; }

    // For storing the transaction being edited
    private TransactionModel? transaction;

    // For storing error messages
    private string errorMessage = string.Empty;

    // OnInitializedAsync to load transaction details
    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = await UserManager.GetUserAsync(authState.User);

            if (user == null)
            {
                errorMessage = "You must be signed in to edit transactions.";
                return;
            }

            transaction = await Db.Transactions
            .Include(t => t.Goal)
            .FirstOrDefaultAsync(t => t.TransactionId == TransactionId && t.UserId == user.Id);

            if (transaction == null)
            {
                errorMessage = "Transaction not found or you do not have access.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading transaction: {ex.Message}";
        }
    }

    // Handler for form submission to save edited transaction
    private async Task HandleEditTransaction()
    {
        try
        {
            if (transaction == null) return;

            await Db.SaveChangesAsync();
            Nav.NavigateTo($"/goaldetails/{transaction.GoalId}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving transaction: {ex.Message}";
        }
    }
}