@page "/addgoal"
@layout MainLayout
@using GoalGrower.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using GoalGrower.Models
@using System.ComponentModel.DataAnnotations

@rendermode InteractiveServer
@inject UserManager<UserModel> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<UserModel> UserManager
@inject AppDbContext Db
@inject NavigationManager Nav

<PageTitle>Add New Goal</PageTitle>

<h1>Add New Goal</h1>

<EditForm FormName="AddGoalForm" Model="goalModel" OnValidSubmit="HandleAddGoal">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div>
        <label for="GoalName">Goal Name</label>
        <InputText id="GoalName" @bind-Value="goalModel.GoalName" placeholder="Goal Name" />
        <ValidationMessage For="() => goalModel.GoalName" />
    </div>
    <div>
        <label for="GoalDescription">Goal Description</label>
        <InputText id="GoalDescription" @bind-Value="goalModel.GoalDescription" placeholder="Description" />
        <ValidationMessage For="() => goalModel.GoalDescription" />
    </div>
    <div>
        <label for="GoalAmount">Amount to be Saved</label>
        <InputNumber id="GoalAmount" @bind-Value="goalModel.GoalAmount" TValue="decimal"/>
        <ValidationMessage For="() => goalModel.GoalAmount" />
    </div>
    <div>
        <label for="CompletionDate">Expected Completion Date</label>
        <InputDate id="CompletionDate" @bind-Value="goalModel.CompletionDate" TValue="DateTime"/>
        <ValidationMessage For="() => goalModel.CompletionDate" />
    </div>
    <div class="form-button-options">
        <button type="submit">Add Goal</button>
        <a class="cancel-button" href="/dashboard">Cancel</a>
    </div>
    
</EditForm>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; } = default!;
    private GoalModel goalModel { get; set; } = new GoalModel(){
        CompletionDate = DateTime.Today.AddDays(1) // default to tomorrow
    };
    private string errorMessage = string.Empty;
    protected override async Task OnInitializedAsync()
    {
        // Set UserId early to satisfy the [Required] attribute for validation
        var authState = await AuthStateTask;
        var principal = authState.User;
        var user = await UserManager.GetUserAsync(principal);

        if (user is not null)
        {
            goalModel.UserId = user.Id;
        }
        else
        {
            // Handle unauthenticated user case if necessary (e.g., redirect to login)
            errorMessage = "Authentication failed. User not found.";
        }
    }
    private async Task HandleAddGoal()
    {
        Console.WriteLine("HandleAddGoal called");
        errorMessage = string.Empty;
        try
        {
        // Get current user
         if (string.IsNullOrEmpty(goalModel.UserId))
            {
                errorMessage = "User not found.";
                return;
            }
            // Save to database
            Db.Goals.Add(goalModel);
            await Db.SaveChangesAsync();
            errorMessage = "Goal saved successfully!"; // temporary confirmation

            // Redirect back to dashboard
            Nav.NavigateTo("/dashboard");
        }
        catch (DbUpdateException dbEx)
        {
            // Catch specific DB exceptions for better error reporting
            errorMessage = $"Database Error saving goal. Check constraints: {dbEx.Message}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving goal: {ex.Message}";
        }
    }
}